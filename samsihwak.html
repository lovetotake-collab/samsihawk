<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¼ì‹œí™• ë§¤ë§¤ v10 (ì‹ ê³ ê°€ ë±ƒì§€ ì¶”ê°€)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="number"], select {
            border: 2px solid #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }
        select {
            cursor: pointer;
            background-color: white;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .input-gray { background: #f3f4f6; border-color: #9ca3af; }
        .input-chart { background: #e0e7ff; border-color: #818cf8; }
        .input-high { background: #fee2e2; border-color: #fca5a5; }
        .input-low { background: #dbeafe; border-color: #93c5fd; }
        .input-bounce { background: #d1fae5; border-color: #6ee7b7; }
        .input-date { background: #fef3c7; border-color: #fbbf24; }
        
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-reset {
            background: #6b7280;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-reset:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }
        
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-google:hover {
            background: #357ae8;
        }
        .btn-google:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-backup:hover:not(:disabled) {
            background: #059669;
        }
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-load:hover:not(:disabled) {
            background: #d97706;
        }
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .sync-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .sync-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        .sync-status.syncing {
            background: #fef3c7;
            color: #92400e;
        }
        
        .buy-box {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid;
            transition: all 0.2s;
        }
        .buy-box:hover {
            transform: translateX(4px);
        }
        
        /* ì‹¤ì‹œê°„ ì‹œì„¸ ìŠ¤íƒ€ì¼ */
        .price-up { color: #dc2626; font-weight: bold; }
        .price-down { color: #2563eb; font-weight: bold; }
        .price-flat { color: #1f2937; font-weight: bold; }
        
        /* ê·¼ì ‘ (í˜„ì¬ê°€ > ë§¤ìˆ˜íƒ€ì ): ë…¹ìƒ‰ ë°•ìŠ¤ */
        .proximity-box {
            background: #bbf7d0 !important;
            border: 2px solid #22c55e !important;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            animation: pulse-green 1.5s infinite;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* ë„ë‹¬ (í˜„ì¬ê°€ â‰ˆ ë§¤ìˆ˜íƒ€ì ): ì£¼í™©ìƒ‰ ë°•ìŠ¤ */
        .proximity-box-equal {
            background: #fed7aa !important;
            border: 2px solid #f97316 !important;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.5);
            animation: pulse-orange 1.5s infinite;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        @keyframes pulse-orange {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* ë„ë‹¬ ì´í•˜ (í˜„ì¬ê°€ < ë§¤ìˆ˜íƒ€ì ): ì£¼í™©ìƒ‰ ì‹¤ì„  ë°•ìŠ¤ */
        .proximity-box-below {
            background: white !important;
            border: 2px solid #f97316 !important;
            color: #f97316 !important;
            font-weight: bold;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        /* ë§¤ë„íƒ€ì  ê·¼ì ‘ (í˜„ì¬ê°€ < ë§¤ë„íƒ€ì , 1% ì´ë‚´): íŒŒë€ìƒ‰ ë°•ìŠ¤ */
        .sell-proximity-box {
            background: #bfdbfe !important;
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: pulse-blue 1.5s infinite;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        @keyframes pulse-blue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* ë§¤ë„íƒ€ì  ë„ë‹¬ (í˜„ì¬ê°€ >= ë§¤ë„íƒ€ì ): íŒŒë€ìƒ‰ ì‹¤ì„  ë°•ìŠ¤ */
        .sell-proximity-box-reached {
            background: white !important;
            border: 2px solid #3b82f6 !important;
            color: #3b82f6 !important;
            font-weight: bold;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .api-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .api-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .realtime-price {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background: #f3f4f6;
            margin-left: 8px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.3;
        }
        
        .realtime-price-value {
            font-weight: bold;
            font-size: 13px;
        }
        
        .realtime-price-change {
            font-size: 11px;
            margin-top: 2px;
        }
        
        .buy-40 { background: #fce7f3; border-color: #f472b6; }
        .buy-50 { background: #dbeafe; border-color: #60a5fa; }
        .buy-60 { background: #fef9c3; border-color: #facc15; }
        .buy-70 { background: #fee2e2; border-color: #f87171; }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .drag-handle {
            cursor: move;
            color: #9ca3af;
            padding: 0 8px;
            user-select: none;
        }
        .drag-handle:hover {
            color: #667eea;
        }
        
        /* ì•Œë¦¼ ì„¤ì • ìŠ¤íƒ€ì¼ */
        .alert-settings-btn {
            background: #f59e0b;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        .alert-settings-btn:hover {
            background: #d97706;
        }
        
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .alert-modal.active {
            display: flex;
        }
        .alert-modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }
        
        table {
            border-collapse: collapse;
        }
        table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        table tr:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .d-day-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        .d-day-badge.orange {
            background: #f97316;
            color: white;
        }
        .d-day-badge.warning {
            background: #fbbf24;
            color: #78350f;
        }
        .d-day-badge.danger {
            background: #ef4444;
            color: white;
        }
        
        .rise-rate-badge {
            display: inline-block;
            background: #9ca3af;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        .rise-rate-badge.green {
            background: #10b981;
        }
        .rise-rate-badge.orange {
            background: #f97316;
        }
        .rise-rate-badge.red {
            background: #ef4444;
        }
        
        /* [ì¶”ê°€] ì‹ ê³ ê°€ ê°±ì‹  ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .new-high-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 1px 5px;
            border-radius: 4px;
            margin-left: 6px;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.4);
            animation: pulse-red 1.5s infinite;
            vertical-align: middle;
            border: 1px solid #b91c1c;
        }

        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .stock-list-section {
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .minute-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
        }
        .daily-section {
            background: #dbeafe;
            border: 2px solid #60a5fa;
        }
        
        @media (max-width: 768px) {
            .grid.grid-cols-3 {
                grid-template-columns: 1fr;
            }
            .grid.grid-cols-6 {
                grid-template-columns: repeat(2, 1fr);
            }
            table {
                font-size: 10px;
            }
            table th, table td {
                padding: 6px 2px !important;
            }
            .buy-box {
                padding: 12px;
            }
            .d-day-badge {
                font-size: 9px;
                padding: 1px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        ğŸ“Š ì‚¼ì‹œí™•ë§¤ë§¤ í™•ì¥íŒ v2
                    </h1>
                    <p class="text-gray-600 mt-2">ì²« ë°˜ë“±ì„ ë…¸ë¦¬ëŠ” ë¶„í• ë§¤ìˆ˜ ì „ëµ (ì‹ ê³ ê°€ ìë™ê°±ì‹  ê¸°ëŠ¥ íƒ‘ì¬)</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2">
                        <button id="alertSettingsBtn" class="alert-settings-btn" onclick="openAlertSettings()">
                            <span>ğŸ””</span>
                            <span>ì•Œë¦¼ ì„¤ì •</span>
                        </button>
                        <div id="apiStatus" class="api-status disconnected">
                            <span>â—</span>
                            <span id="apiStatusText">í‚¤ì›€ API ì—°ê²° ì•ˆë¨</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                            <span>ğŸ’¾</span>
                            <span>ë°±ì—…</span>
                        </button>
                        <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                            <span>ğŸ“¥</span>
                            <span>ë¡œë“œ</span>
                        </button>
                        <button id="googleSignInBtn" class="btn-google" onclick="handleAuthClick()">
                            <svg width="18" height="18" viewBox="0 0 18 18">
                                <path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                                <path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                                <path fill="#fff" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                                <path fill="#fff" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                            </svg>
                            <span id="googleBtnText">êµ¬ê¸€ ë¡œê·¸ì¸</span>
                        </button>
                    </div>
                    <div id="syncStatus" class="sync-status disconnected">
                        <span>â—</span>
                        <span id="statusText">ì—°ê²° ì•ˆë¨</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs text-gray-500"></div>
                </div>
            </div>
        </div>


        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“ ì¢…ëª© ì •ë³´ ì…ë ¥</h2>
            
            <input type="hidden" id="apiServerUrl" value="http://localhost:5000">
            
            <div class="grid grid-cols-6 gap-3">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-indigo-600">ì°¨íŠ¸</label>
                    <select id="chartType" class="input-chart">
                        <option value="minute">ë¶„ë´‰</option>
                        <option value="daily">ì¼ë´‰</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-600">ì¢…ëª©ëª…</label>
                    <input type="text" id="stockName" placeholder="" class="input-gray">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-purple-600">ì¢…ëª©ì½”ë“œ</label>
                    <input type="text" id="stockCode" placeholder="" maxlength="6" class="input-gray">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-amber-600">ê³ ì ì¼</label>
                    <input type="text" id="highDate" placeholder="" class="input-date" maxlength="6" oninput="formatDateInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-red-600">ê³ ì  (ì›)</label>
                    <input type="text" id="highPrice" placeholder="" class="input-high" oninput="formatInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-blue-600">ì €ì  (ì›)</label>
                    <input type="text" id="lowPrice" placeholder="" class="input-low" oninput="formatInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-green-600">ë°˜ë“±ì €ì  (ì›)</label>
                    <input type="text" id="bouncePrice" placeholder="ì„ íƒì‚¬í•­" class="input-bounce" oninput="formatInput(this)">
                </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-3">
                <button class="btn-calculate" onclick="calculate()">
                    âœ… ê³„ì‚°í•˜ê¸°
                </button>
                <button class="btn-calculate" onclick="addToList()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ğŸ’¾ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                </button>
                <button class="btn-reset" onclick="resetInputs()">
                    ğŸ”„ ì…ë ¥ ì´ˆê¸°í™”
                </button>
            </div>
            <div class="mt-3 text-sm text-gray-600 bg-purple-50 p-3 rounded-lg border border-purple-200">
                ğŸ’¡ <strong>íŒ:</strong> ì¥ì¤‘ ê³ ê°€ê°€ ê°±ì‹ ë˜ë©´ <strong>ìë™ìœ¼ë¡œ</strong> íƒ€ì ì´ ìˆ˜ì •ë˜ê³  í…”ë ˆê·¸ë¨ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.
            </div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“‹ ì¢…ëª©ë¦¬ìŠ¤íŠ¸</h2>
            <p class="text-sm text-gray-500 mb-3">ì¢…ëª©ì„ í´ë¦­í•˜ì—¬ ìƒì„¸ íƒ€ì ì„ í™•ì¸í•˜ì„¸ìš”</p>
            
            <div class="stock-list-section minute-section">
                <h3 class="text-lg font-bold mb-3 text-amber-900 flex items-center gap-2">
                    âš¡ ë¶„ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸
                    <span class="text-sm font-normal text-amber-700">(ë‹¨ê¸° ë§¤ë§¤)</span>
                </h3>
                <div id="minuteStockList"></div>
            </div>
            
            <div class="stock-list-section daily-section">
                <h3 class="text-lg font-bold mb-3 text-blue-900 flex items-center gap-2">
                    ğŸ“ˆ ì¼ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸
                    <span class="text-sm font-normal text-blue-700">(ì¤‘ì¥ê¸° ë§¤ë§¤)</span>
                </h3>
                <div id="dailyStockList"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ¯ ë§¤ìˆ˜ íƒ€ì </h2>
                <p class="text-sm text-gray-500 mb-3">í”¼ë³´ë‚˜ì¹˜ ê¸°ì¤€ ë¶„í• ë§¤ìˆ˜ ì§€ì </p>
                <div id="buyPoints"></div>
            </div>

            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700" id="sellTitle">ğŸ’° ë§¤ë„ íƒ€ì </h2>
                <p class="text-sm text-gray-500 mb-3">ë°˜ë“±ì €ì  ê¸°ì¤€ ë§¤ë„ ì§€ì </p>
                <div id="sellPoints">
                    <div class="text-center text-gray-500 py-8">
                        ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì • ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'samsihwak_extended_stocks.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;
        let tokenRefreshTimer = null;

        // ========== ë°ì´í„° ê´€ë¦¬ ==========
        let stockDatabase = [];
        let currentSelectedIndex = -1;
        let draggedIndex = null;

        // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
        const savedData = localStorage.getItem('samsihwakExtendedStocks');
        if (savedData) {
            stockDatabase = JSON.parse(savedData);
        }

        // ========== Socket.IO ì‹¤ì‹œê°„ ì—°ê²° ==========
        let apiServerUrl = 'http://localhost:5000';
        let isKiwoomConnected = false;
        let socket = null;
        
        // Socket.IO ì—°ê²° ì´ˆê¸°í™”
        function initSocketConnection() {
            if (socket && socket.connected) {
                socket.disconnect();
            }
            
            socket = io(apiServerUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: Infinity
            });
            
            // ì—°ê²° ì„±ê³µ
            socket.on('connect', () => {
                console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
                isKiwoomConnected = true;
                updateAPIStatus('connected', 'í‚¤ì›€ API ì—°ê²°ë¨');
                registerAllStocks();
            });
            
            // ì—°ê²° ëŠê¹€
            socket.on('disconnect', (reason) => {
                console.log('âŒ WebSocket ì—°ê²° ëŠê¹€:', reason);
                isKiwoomConnected = false;
                updateAPIStatus('disconnected', 'ì¬ì—°ê²° ì‹œë„ ì¤‘...');
                
                // ì„œë²„ê°€ ê°•ì œ ì¢…ë£Œí•œ ê²½ìš° ìˆ˜ë™ ì¬ì—°ê²°
                if (reason === 'io server disconnect') {
                    setTimeout(() => {
                        console.log('ğŸ”„ ìˆ˜ë™ ì¬ì—°ê²° ì‹œë„...');
                        socket.connect();
                    }, 3000);
                }
            });
            
            // ì—°ê²° ìƒíƒœ ìˆ˜ì‹ 
            socket.on('connection_status', (data) => {
                if (data.logged_in) {
                    isKiwoomConnected = true;
                    updateAPIStatus('connected', 'í‚¤ì›€ API ì—°ê²°ë¨');
                } else {
                    isKiwoomConnected = false;
                    updateAPIStatus('disconnected', 'í‚¤ì›€ API ë¡œê·¸ì¸ í•„ìš”');
                }
            });
            
            // ë“±ë¡ ì„±ê³µ
            socket.on('registration_success', (data) => {
                console.log(`ğŸŸ¢ ${data.message}`);
            });
            
            // ì—ëŸ¬ ìˆ˜ì‹ 
            socket.on('error', (data) => {
                console.error('âŒ ì˜¤ë¥˜:', data.message);
            });
            
            // [ìˆ˜ì •ë¨] ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ë° ì‹ ê³ ê°€ ê°±ì‹  ë¡œì§
            socket.on('realtime_update', (data) => {
                const { code, name, data: priceData } = data;
                
                // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì¢…ëª© ì°¾ê¸°
                const stock = stockDatabase.find(s => s.code === code);
                
                if (stock) {
                    const currentPrice = priceData.current_price;
                    
                    // ==========================================
                    // [ì¶”ê°€ëœ ê¸°ëŠ¥] ì‹ ê³ ê°€ ê°±ì‹  ìë™ ê°ì§€ ë¡œì§
                    // ==========================================
                    if (stock.high && currentPrice > stock.high) {
                        const oldHigh = stock.high;
                        
                        // 1. ë°ì´í„° ì—…ë°ì´íŠ¸
                        stock.high = currentPrice;
                        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê°±ì‹  (YYMMDD)
                        const today = new Date();
                        const yymmdd = today.toISOString().slice(2, 10).replace(/-/g, '');
                        stock.highDate = yymmdd;
                        
                        // 2. ì„œë²„ì— í…”ë ˆê·¸ë¨ ì•Œë¦¼ ìš”ì²­ (ì†Œì¼“ ì „ì†¡)
                        if (socket && socket.connected) {
                            socket.emit('req_high_update_alert', {
                                code: stock.code,
                                name: stock.name,
                                old_high: oldHigh,
                                new_high: currentPrice
                            });
                        }
                        
                        // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                        
                        // 4. í™”ë©´ ë¦¬ë Œë”ë§ (ë³€ê²½ëœ íƒ€ì  ì¦‰ì‹œ ë°˜ì˜)
                        renderStockList();
                        
                        // 5. ì„œë²„ ê°ì‹œ íƒ€ì  ì¬ë“±ë¡ (ë³€ê²½ëœ íƒ€ì ìœ¼ë¡œ ì„œë²„ ê°ì‹œ ì—…ë°ì´íŠ¸)
                        // ë””ë°”ìš´ì‹±: ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì£¼ì–´ ë„ˆë¬´ ë¹ˆë²ˆí•œ ì¬ë“±ë¡ ë°©ì§€
                        if (!stock._updateTimer) {
                            stock._updateTimer = setTimeout(() => {
                                registerAllStocks();
                                stock._updateTimer = null;
                            }, 1000);
                        }
                        
                        // ìƒì„¸í™”ë©´ì´ ì—´ë ¤ìˆê³  í•´ë‹¹ ì¢…ëª©ì´ë¼ë©´ ìƒì„¸í™”ë©´ë„ ê°±ì‹ 
                        if (currentSelectedIndex !== -1 && stockDatabase[currentSelectedIndex].code === code) {
                            loadStock(currentSelectedIndex);
                        }
                    }
                    // ==========================================
                    
                    // ê¸°ì¡´ ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§
                    stock.currentPrice = priceData.current_price;
                    stock.changeRate = priceData.change_rate;
                    stock.prevDiff = priceData.prev_diff;
                    
                    // ë§¤ìˆ˜íƒ€ì  ë„ë‹¬ ì´ë ¥ ì—…ë°ì´íŠ¸
                    updateStockHistory(stock);
                    
                    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
                    localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                    
                    // DOM ë¶€ë¶„ ì—…ë°ì´íŠ¸ (Partial Update) - í´ë¦­ ë°©í•´ ë°©ì§€
                    const priceEl = document.getElementById(`price-${code}`);
                    const rateEl = document.getElementById(`rate-${code}`);
                    
                    if (priceEl && rateEl) {
                        const changeRate = priceData.change_rate;
                        
                        const priceClass = changeRate > 0 ? 'price-up' : changeRate < 0 ? 'price-down' : 'price-flat';
                        const sign = changeRate > 0 ? 'â–²' : changeRate < 0 ? 'â–¼' : '';
                        
                        // í…ìŠ¤íŠ¸ ë‚´ìš©ê³¼ í´ë˜ìŠ¤ë§Œ ë³€ê²½ (DOM êµ¬ì¡° ìœ ì§€)
                        priceEl.textContent = `${parseInt(currentPrice).toLocaleString()}ì›`;
                        priceEl.className = `realtime-price-value ${priceClass}`;
                        
                        rateEl.textContent = `${sign} ${Math.abs(changeRate).toFixed(2)}%`;
                        rateEl.className = `realtime-price-change ${priceClass}`;
                    }
                }
            });
            
            // ë§¤ìˆ˜/ë§¤ë„íƒ€ì  ì•Œë¦¼ ìˆ˜ì‹ 
            socket.on('price_alert', (data) => {
                const { name, current_price, target_point, point_label, diff_percent, type, status, watch_mode } = data;
                
                const modeText = watch_mode === 'sell' ? 'ë§¤ë„' : 'ë§¤ìˆ˜';
                console.log(`ğŸ”” ${modeText}íƒ€ì  ì•Œë¦¼ ìˆ˜ì‹ :`, data);
                
                // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
                const targetLabel = watch_mode === 'sell' ? `ë§¤ë„(${point_label})` : `ë§¤ìˆ˜(${point_label})`;
                const message = `
                    <strong>${name}</strong><br>
                    í˜„ì¬ê°€: â‚©${current_price.toLocaleString()}<br>
                    ${targetLabel}: â‚©${(target_point || 0).toLocaleString()}<br>
                    ì°¨ì´: ${diff_percent > 0 ? '+' : ''}${diff_percent.toFixed(2)}%
                `;
                
                showAlertToast(message, type, watch_mode || 'buy');
            });
        }
        
        // ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì‹œ ì´ë ¥ ì—…ë°ì´íŠ¸ ë¡œì§ ë¶„ë¦¬
        function updateStockHistory(stock) {
            // ì°¨íŠ¸ íƒ€ì…ì— ë”°ë¥¸ íƒ€ì  ê³„ì‚°
            const diff = stock.high - stock.low;
            const buyPoints = {
                buy40: adjustBuyPrice(stock.high - (diff * 0.382)).adjusted,
                buy45: adjustBuyPrice(stock.high - (diff * 0.45)).adjusted,
                buy50: adjustBuyPrice(stock.high - (diff * 0.5)).adjusted,
                buy55: adjustBuyPrice(stock.high - (diff * 0.55)).adjusted,
                buy60: adjustBuyPrice(stock.high - (diff * 0.6)).adjusted,
                buy65: adjustBuyPrice(stock.high - (diff * 0.65)).adjusted,
                buy70: adjustBuyPrice(stock.high - (diff * 0.7)).adjusted
            };
            
            // ì´ë ¥ ê°ì²´ ì´ˆê¸°í™”
            if (!stock.reachedHistory) {
                stock.reachedHistory = {};
            }
            
            // ë„ë‹¬ ì—¬ë¶€ ì²´í¬
            if (stock.currentPrice) {
                if (stock.currentPrice <= buyPoints.buy40 && !stock.reachedHistory.reached40) stock.reachedHistory.reached40 = true;
                if (stock.currentPrice <= buyPoints.buy45 && !stock.reachedHistory.reached45) stock.reachedHistory.reached45 = true;
                if (stock.currentPrice <= buyPoints.buy50 && !stock.reachedHistory.reached50) stock.reachedHistory.reached50 = true;
                if (stock.currentPrice <= buyPoints.buy55 && !stock.reachedHistory.reached55) stock.reachedHistory.reached55 = true;
                if (stock.currentPrice <= buyPoints.buy60 && !stock.reachedHistory.reached60) stock.reachedHistory.reached60 = true;
                if (stock.currentPrice <= buyPoints.buy65 && !stock.reachedHistory.reached65) stock.reachedHistory.reached65 = true;
                if (stock.currentPrice <= buyPoints.buy70 && !stock.reachedHistory.reached70) stock.reachedHistory.reached70 = true;
                
                // ë§¤ë„ íƒ€ì  ë„ë‹¬ ì²´í¬
                if (stock.bounce !== null && stock.bounce !== undefined) {
                    const bounceRange = stock.high - stock.bounce;
                    const sell25 = adjustSellPrice(stock.bounce + (bounceRange * 0.25)).adjusted;
                    const sell33 = adjustSellPrice(stock.bounce + (bounceRange * 0.33)).adjusted;
                    const sell50 = adjustSellPrice(stock.bounce + (bounceRange * 0.50)).adjusted;
                    const sell75 = adjustSellPrice(stock.bounce + (bounceRange * 0.75)).adjusted;
                    
                    if (stock.currentPrice >= sell25 && !stock.reachedHistory.reachedSell25) stock.reachedHistory.reachedSell25 = true;
                    if (stock.currentPrice >= sell33 && !stock.reachedHistory.reachedSell33) stock.reachedHistory.reachedSell33 = true;
                    if (stock.currentPrice >= sell50 && !stock.reachedHistory.reachedSell50) stock.reachedHistory.reachedSell50 = true;
                    if (stock.currentPrice >= sell75 && !stock.reachedHistory.reachedSell75) stock.reachedHistory.reachedSell75 = true;
                }
            }
        }
        
        // ëª¨ë“  ì¢…ëª©ì„ ì„œë²„ì— ë“±ë¡ (ë°˜ë“±ì €ì  ìœ ë¬´ì— ë”°ë¼ ë§¤ìˆ˜/ë§¤ë„íƒ€ì  ìë™ ì „í™˜)
        function registerAllStocks() {
            if (!socket || !socket.connected) return;
            
            // ë¶„ë´‰ ì¢…ëª© ë“±ë¡
            const minuteStocks = stockDatabase
                .filter(s => s.code && s.chartType === 'minute')
                .map(s => buildStockRegistration(s, 'minute'));
            
            if (minuteStocks.length > 0) {
                socket.emit('register_stocks', { 
                    source: 'samsihwak_ë¶„ë´‰',
                    stocks: minuteStocks 
                });
                const buyCount = minuteStocks.filter(s => s.watch_mode === 'buy').length;
                const sellCount = minuteStocks.filter(s => s.watch_mode === 'sell').length;
                console.log(`ğŸ“¡ [samsihwak_ë¶„ë´‰] ì‹¤ì‹œê°„ ì‹œì„¸ ë“±ë¡: ë§¤ìˆ˜ê°ì‹œ ${buyCount}ê°œ, ë§¤ë„ê°ì‹œ ${sellCount}ê°œ`);
            }
            
            // ì¼ë´‰ ì¢…ëª© ë“±ë¡
            const dailyStocks = stockDatabase
                .filter(s => s.code && s.chartType === 'daily')
                .map(s => buildStockRegistration(s, 'daily'));
            
            if (dailyStocks.length > 0) {
                socket.emit('register_stocks', { 
                    source: 'samsihwak_ì¼ë´‰',
                    stocks: dailyStocks 
                });
                const buyCount = dailyStocks.filter(s => s.watch_mode === 'buy').length;
                const sellCount = dailyStocks.filter(s => s.watch_mode === 'sell').length;
                console.log(`ğŸ“¡ [samsihwak_ì¼ë´‰] ì‹¤ì‹œê°„ ì‹œì„¸ ë“±ë¡: ë§¤ìˆ˜ê°ì‹œ ${buyCount}ê°œ, ë§¤ë„ê°ì‹œ ${sellCount}ê°œ`);
            }
        }
        
        function buildStockRegistration(s, chartType) {
            let targetPoints = [];
            let watchMode = 'buy';
            let pointLabels = [];
            
            if (s.high && s.low) {
                const range = s.high - s.low;
                
                // ë°˜ë“±ì €ì ì´ ìˆìœ¼ë©´ ë§¤ë„íƒ€ì  ê°ì‹œ, ì—†ìœ¼ë©´ ë§¤ìˆ˜íƒ€ì  ê°ì‹œ
                if (s.bounce !== null && s.bounce !== undefined) {
                    // ë§¤ë„íƒ€ì  ê°ì‹œ ëª¨ë“œ - 25%, 33%, 50%, 75% ë°˜ë“±
                    const bounceRange = s.high - s.bounce;
                    watchMode = 'sell';
                    
                    targetPoints = [
                        adjustSellPrice(s.bounce + (bounceRange * 0.25)).adjusted,
                        adjustSellPrice(s.bounce + (bounceRange * 0.33)).adjusted,
                        adjustSellPrice(s.bounce + (bounceRange * 0.50)).adjusted,
                        adjustSellPrice(s.bounce + (bounceRange * 0.75)).adjusted
                    ];
                    pointLabels = ['25%ë°˜ë“±', '33%ë°˜ë“±', '50%ë°˜ë“±', '75%ë°˜ë“±'];
                    
                } else {
                    // ë§¤ìˆ˜íƒ€ì  ê°ì‹œ ëª¨ë“œ
                    watchMode = 'buy';
                    
                    if (chartType === 'daily') {
                        // ì¼ë´‰: 38.2%, 45%, 50%, 55%, 60%, 65%, 70%
                        targetPoints = [
                            adjustBuyPrice(s.high - (range * 0.382)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.45)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.50)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.55)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.60)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.65)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.70)).adjusted
                        ];
                        pointLabels = ['40%', '45%', '50%', '55%', '60%', '65%', '70%'];
                    } else {
                        // ë¶„ë´‰: 38.2%, 50%, 60%, 70%
                        targetPoints = [
                            adjustBuyPrice(s.high - (range * 0.382)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.50)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.60)).adjusted,
                            adjustBuyPrice(s.high - (range * 0.70)).adjusted
                        ];
                        pointLabels = ['40%', '50%', '60%', '70%'];
                    }
                }
            }
            
            return {
                code: s.code,
                name: s.name,
                watch_mode: watchMode,
                target_points: targetPoints,
                point_labels: pointLabels,
                high: s.high,
                low: s.low,
                bounce: s.bounce
            };
        }

        // í‚¤ì›€ API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function connectKiwoomAPI() {
            const urlInput = document.getElementById('apiServerUrl');
            apiServerUrl = urlInput.value.trim();
            
            if (!apiServerUrl) {
                alert('API ì„œë²„ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch(`${apiServerUrl}/api/login_status`);
                const data = await response.json();
                
                if (data.logged_in) {
                    alert('âœ… í‚¤ì›€ API ì—°ê²° ì„±ê³µ! WebSocket ì‹¤ì‹œê°„ ì—°ê²°ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
                    initSocketConnection();
                } else {
                    alert('âŒ í‚¤ì›€ APIì— ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\në¨¼ì € í‚¤ì›€ ì„œë²„(python app.py)ë¥¼ ì‹¤í–‰í•˜ê³  ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    updateAPIStatus('disconnected', 'í‚¤ì›€ API ë¡œê·¸ì¸ í•„ìš”');
                }
            } catch (error) {
                console.error('API ì—°ê²° ì˜¤ë¥˜:', error);
                updateAPIStatus('disconnected', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                alert('âŒ API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì„œë²„ ì£¼ì†Œë¥¼ í™•ì¸í•˜ê±°ë‚˜ í‚¤ì›€ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
            }
        }

        // API ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAPIStatus(status, text) {
            const statusEl = document.getElementById('apiStatus');
            const textEl = document.getElementById('apiStatusText');
            
            statusEl.className = `api-status ${status}`;
            textEl.textContent = text;
        }

        // ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘ë„ ì²´í¬
        function checkProximity(currentPrice, targetPrice, chartType = 'minute') {
            if (!currentPrice || !targetPrice) return { isClose: false, isEqual: false, isBelow: false };
            
            const diff = currentPrice - targetPrice;
            const percentage = (diff / targetPrice) * 100;
            
            let closeMax, equalMax;
            if (chartType === 'daily') {
                closeMax = 3.0; 
                equalMax = 1.0; 
            } else {
                closeMax = 1.0; 
                equalMax = 0.3; 
            }
            
            if (diff < 0) return { isClose: false, isEqual: false, isBelow: true };
            if (percentage >= 0 && percentage <= equalMax) return { isClose: false, isEqual: true, isBelow: false };
            if (percentage > equalMax && percentage <= closeMax) return { isClose: true, isEqual: false, isBelow: false };
            
            return { isClose: false, isEqual: false, isBelow: false };
        }
        
        // ë§¤ë„íƒ€ì  ê·¼ì ‘ë„ ì²´í¬
        function checkSellProximity(currentPrice, targetPrice, chartType = 'minute') {
            if (!currentPrice || !targetPrice) return { isClose: false, isReached: false };
            
            const diff = currentPrice - targetPrice;
            const percentage = (diff / targetPrice) * 100;
            const closeMax = chartType === 'daily' ? 3.0 : 1.0;
            
            if (diff >= 0) return { isClose: false, isReached: true };
            if (percentage >= -closeMax && percentage < 0) return { isClose: true, isReached: false };
            
            return { isClose: false, isReached: false };
        }


        // ========== Google API ì´ˆê¸°í™” ë° ì¸ì¦ ==========
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; maybeEnableButtons(); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableButtons(); }
        function maybeEnableButtons() { if (gapiInited && gisInited) document.getElementById('googleSignInBtn').disabled = false; }
        
        function handleAuthClick() {
            if (isSignedIn) handleSignoutClick();
            else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) throw (resp);
                    localStorage.setItem('google_access_token_samsihwak', resp.access_token);
                    if (resp.expires_in) localStorage.setItem('google_token_expiry_samsihwak', (Date.now() + (resp.expires_in * 1000)).toString());
                    setupTokenRefresh(resp.expires_in);
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };
                if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
                else tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            if (tokenRefreshTimer) { clearTimeout(tokenRefreshTimer); tokenRefreshTimer = null; }
            localStorage.removeItem('google_access_token_samsihwak');
            localStorage.removeItem('google_token_expiry_samsihwak');
            isSignedIn = false;
            updateSyncStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
            document.getElementById('googleBtnText').textContent = 'êµ¬ê¸€ ë¡œê·¸ì¸';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }

        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token_samsihwak');
            const tokenExpiry = localStorage.getItem('google_token_expiry_samsihwak');
            if (savedToken && tokenExpiry) {
                if (Date.now() < parseInt(tokenExpiry)) {
                    gapi.client.setToken({ access_token: savedToken });
                    isSignedIn = true;
                    driveFileId = await findDriveFile();
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    setupTokenRefresh(Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000));
                } else {
                    localStorage.removeItem('google_access_token_samsihwak');
                    localStorage.removeItem('google_token_expiry_samsihwak');
                    tryAutoRelogin();
                }
            }
        }
        
        function tryAutoRelogin() {
            if (tokenClient) {
                tokenClient.callback = async (resp) => {
                    if (resp.error === undefined) {
                        isSignedIn = true;
                        localStorage.setItem('google_access_token_samsihwak', resp.access_token);
                        if (resp.expires_in) {
                            localStorage.setItem('google_token_expiry_samsihwak', (Date.now() + (resp.expires_in * 1000)).toString());
                            setupTokenRefresh(resp.expires_in);
                        }
                        gapi.client.setToken({ access_token: resp.access_token });
                        driveFileId = await findDriveFile();
                        updateSyncStatus('connected', 'ì—°ê²°ë¨');
                        document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                        document.getElementById('backupBtn').disabled = false;
                        document.getElementById('loadBtn').disabled = false;
                    }
                };
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function setupTokenRefresh(expiresInSeconds) {
            if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                localStorage.setItem('google_access_token_samsihwak', resp.access_token);
                                if (resp.expires_in) {
                                    localStorage.setItem('google_token_expiry_samsihwak', (Date.now() + (resp.expires_in * 1000)).toString());
                                    setupTokenRefresh(resp.expires_in);
                                }
                                gapi.client.setToken({ access_token: resp.access_token });
                            } else throw new Error(resp.error);
                        };
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        if (typeof handleSignoutClick === 'function') handleSignoutClick();
                    }
                }
            }, refreshTime);
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = `sync-status ${status}`;
            textEl.textContent = text;
        }

        function updateLastSyncTime() {
            const now = new Date();
            document.getElementById('lastSyncTime').textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${now.toLocaleString('ko-KR')}`;
        }

        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                return response.result.files?.[0]?.id || null;
            } catch (err) { return null; }
        }

        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            updateSyncStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            try {
                driveFileId = await findDriveFile();
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    stockDatabase = JSON.parse(response.body);
                    localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                    renderStockList();
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    updateLastSyncTime();
                    registerAllStocks();
                } else updateSyncStatus('connected', 'ì—°ê²°ë¨ (íŒŒì¼ ì—†ìŒ)');
            } catch (err) { updateSyncStatus('connected', 'ì—°ê²°ë¨'); }
        }

        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
            try {
                const data = JSON.stringify(stockDatabase, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const metadata = { name: FILE_NAME, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                if (driveFileId) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                } else {
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    const result = await response.json();
                    driveFileId = result.id;
                }
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
                updateLastSyncTime();
            } catch (err) { updateSyncStatus('connected', 'ì—°ê²°ë¨ (ì €ì¥ ì‹¤íŒ¨)'); }
        }

        async function manualBackup() {
            if (!isSignedIn) { alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await saveToGoogleDrive(); alert('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'); }
        }

        async function manualLoad() {
            if (!isSignedIn) { alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) { await loadFromGoogleDrive(); alert('ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!'); }
        }

        // ========== í˜¸ê°€ë‹¨ìœ„ ê³„ì‚° ==========
        function getTickSize(price) {
            if (price < 2000) return 1;
            if (price < 5000) return 5;
            if (price < 20000) return 10;
            if (price < 50000) return 50;
            if (price < 200000) return 100;
            if (price < 500000) return 500;
            return 1000;
        }

        function adjustBuyPrice(price) {
            const tickSize = getTickSize(price);
            const adjusted = Math.ceil(price / tickSize) * tickSize;
            return { original: price, adjusted: adjusted };
        }

        function adjustSellPrice(price) {
            const tickSize = getTickSize(price);
            const adjusted = Math.floor(price / tickSize) * tickSize;
            return { original: price, adjusted: adjusted };
        }

        // ========== í¬ë§·íŒ… í•¨ìˆ˜ ==========
        function formatDateInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 6) value = value.substring(0, 6);
            input.value = value;
        }

        function formatInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) input.value = parseInt(value).toLocaleString('ko-KR');
        }

        function formatPrice(price) {
            return Math.round(price).toLocaleString('ko-KR');
        }

        function formatPriceWithOriginal(adjusted, original) {
            const formattedAdjusted = formatPrice(adjusted);
            if (Math.abs(adjusted - original) > 0.01) {
                return `${formattedAdjusted}ì› <span class="text-xs text-gray-500">(${formatPrice(original)}ì›)</span>`;
            }
            return `${formattedAdjusted}ì›`;
        }

        function getNumericValue(elementId) {
            const value = document.getElementById(elementId).value.replace(/,/g, '');
            return value ? parseFloat(value) : null;
        }

        // ========== í•œêµ­ ê³µíœ´ì¼ ë° D-Day ê³„ì‚° ==========
        function getKoreanHolidays(year) {
            const holidays = [
                new Date(year, 0, 1), new Date(year, 2, 1), new Date(year, 4, 5),
                new Date(year, 5, 6), new Date(year, 7, 15), new Date(year, 9, 3),
                new Date(year, 9, 9), new Date(year, 11, 25)
            ];
            if (year === 2025) {
                holidays.push(new Date(2025, 0, 28), new Date(2025, 0, 29), new Date(2025, 0, 30));
                holidays.push(new Date(2025, 4, 5), new Date(2025, 9, 5), new Date(2025, 9, 6), new Date(2025, 9, 7));
            }
            return holidays;
        }

        function isBusinessDay(date, holidays) {
            const day = date.getDay();
            if (day === 0 || day === 6) return false;
            return !holidays.some(h => h.getFullYear() === date.getFullYear() && h.getMonth() === date.getMonth() && h.getDate() === date.getDate());
        }

        function calculateDDay(dateStr) {
            if (!dateStr || dateStr.length !== 6) return { text: '', days: 0 };
            try {
                const year = 2000 + parseInt(dateStr.substring(0, 2));
                const month = parseInt(dateStr.substring(2, 4)) - 1;
                const day = parseInt(dateStr.substring(4, 6));
                const targetDate = new Date(year, month, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                targetDate.setHours(0, 0, 0, 0);
                
                let businessDays = 0;
                if (today > targetDate) {
                    let current = new Date(targetDate);
                    current.setDate(current.getDate() + 1);
                    while (current <= today) {
                        if (isBusinessDay(current, getKoreanHolidays(current.getFullYear()))) businessDays++;
                        current.setDate(current.getDate() + 1);
                    }
                }
                return { text: businessDays > 0 ? `D+${businessDays}` : 'D-Day', days: businessDays };
            } catch (e) { return { text: '', days: 0 }; }
        }

        // ========== ì´ˆê¸°í™” ë° ê³„ì‚° ==========
        function resetInputs() {
            document.getElementById('chartType').value = 'minute';
            document.getElementById('stockName').value = '';
            document.getElementById('stockCode').value = '';
            document.getElementById('highDate').value = '';
            document.getElementById('highPrice').value = '';
            document.getElementById('lowPrice').value = '';
            document.getElementById('bouncePrice').value = '';
            document.getElementById('buyPoints').innerHTML = '';
            document.getElementById('sellTitle').textContent = 'ğŸ’° ë§¤ë„ íƒ€ì ';
            document.getElementById('sellPoints').innerHTML = `<div class="text-center text-gray-500 py-8">ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤</div>`;
            currentSelectedIndex = -1;
            renderStockList();
        }

        function calculate() {
            const high = getNumericValue('highPrice');
            const low = getNumericValue('lowPrice');
            const bounce = getNumericValue('bouncePrice');
            if (high === null || low === null || high <= low) { alert('ê³ ì ê³¼ ì €ì ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

            const diff = high - low;
            const buy40 = adjustBuyPrice(high - (diff * 0.382));
            const buy50 = adjustBuyPrice(high - (diff * 0.5));
            const buy60 = adjustBuyPrice(high - (diff * 0.6));
            const buy70 = adjustBuyPrice(high - (diff * 0.7));

            document.getElementById('buyPoints').innerHTML = `
                <div class="buy-box buy-40"><div class="flex justify-between items-center"><div><div class="font-bold text-lg">40% ë§¤ìˆ˜ <span class="text-sm text-gray-600">38.2%</span></div><div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div></div><div class="text-2xl font-bold text-pink-600">${formatPriceWithOriginal(buy40.adjusted, buy40.original)}</div></div></div>
                <div class="buy-box buy-50"><div class="flex justify-between items-center"><div><div class="font-bold text-lg">50% ë§¤ìˆ˜</div><div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div></div><div class="text-2xl font-bold text-blue-600">${formatPriceWithOriginal(buy50.adjusted, buy50.original)}</div></div></div>
                <div class="buy-box buy-60"><div class="flex justify-between items-center"><div><div class="font-bold text-lg">60% ë§¤ìˆ˜</div><div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div></div><div class="text-2xl font-bold text-yellow-600">${formatPriceWithOriginal(buy60.adjusted, buy60.original)}</div></div></div>
                <div class="buy-box buy-70"><div class="flex justify-between items-center"><div><div class="font-bold text-lg">70% ë§¤ìˆ˜</div><div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div></div><div class="text-2xl font-bold text-red-600">${formatPriceWithOriginal(buy70.adjusted, buy70.original)}</div></div></div>
            `;

            if (bounce !== null && bounce < high) {
                const bounceRange = high - bounce;
                const sell25 = adjustSellPrice(bounce + (bounceRange * 0.25));
                const sell33 = adjustSellPrice(bounce + (bounceRange * 0.33));
                const sell50 = adjustSellPrice(bounce + (bounceRange * 0.50));
                const sell75 = adjustSellPrice(bounce + (bounceRange * 0.75));
                const riseRate4050 = (((buy40.adjusted - buy50.adjusted) / buy50.adjusted) * 100).toFixed(2);
                
                document.getElementById('sellTitle').innerHTML = `ğŸ’° ë§¤ë„ íƒ€ì  <span class="text-base font-normal text-gray-600">(40-50 ìƒìŠ¹ë¥ : ${riseRate4050}%)</span>`;
                document.getElementById('sellPoints').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300"><div class="flex justify-between items-center"><div class="font-bold">25% ë°˜ë“±</div><div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell25.adjusted, sell25.original)}</div></div></div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300"><div class="flex justify-between items-center"><div class="font-bold">33% ë°˜ë“±</div><div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell33.adjusted, sell33.original)}</div></div></div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300"><div class="flex justify-between items-center"><div class="font-bold">50% ë°˜ë“±</div><div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell50.adjusted, sell50.original)}</div></div></div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300"><div class="flex justify-between items-center"><div class="font-bold">75% ë°˜ë“±</div><div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell75.adjusted, sell75.original)}</div></div></div>
                    </div>
                `;
            } else {
                document.getElementById('sellTitle').textContent = 'ğŸ’° ë§¤ë„ íƒ€ì ';
                document.getElementById('sellPoints').innerHTML = `<div class="text-center text-gray-500 py-8">ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤</div>`;
            }
        }

        // ========== ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ ==========
        function addToList() {
            const chartType = document.getElementById('chartType').value;
            const stockName = document.getElementById('stockName').value;
            const stockCode = document.getElementById('stockCode').value;
            const highDate = document.getElementById('highDate').value;
            const high = getNumericValue('highPrice');
            const low = getNumericValue('lowPrice');
            const bounce = getNumericValue('bouncePrice');

            if (!stockName || high === null || low === null) { alert('ì¢…ëª©ëª…, ê³ ì , ì €ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

            const stockData = {
                chartType, name: stockName, code: stockCode || '', highDate: highDate || '',
                high, low, bounce, timestamp: new Date().toISOString(),
                currentPrice: null, changeRate: null,
                reachedHistory: { reached40: false, reached45: false, reached50: false, reached55: false, reached60: false, reached65: false, reached70: false, reachedSell25: false, reachedSell33: false, reachedSell50: false, reachedSell75: false }
            };

            const existingIndex = stockDatabase.findIndex(stock => stock.name === stockName && stock.chartType === chartType);
            if (existingIndex !== -1) {
                stockDatabase[existingIndex] = stockData;
                alert(`"${stockName}" (${chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰'}) ì—…ë°ì´íŠ¸ë¨!`);
            } else {
                stockDatabase.unshift(stockData);
                alert(`"${stockName}" ì¶”ê°€ë¨!`);
            }
            
            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
            renderStockList();
            registerAllStocks();
        }

        function renderStockList() {
            renderStockTable('minuteStockList', stockDatabase.filter(s => s.chartType === 'minute'), 'minute');
            renderStockTable('dailyStockList', stockDatabase.filter(s => s.chartType === 'daily'), 'daily');
        }

        function renderStockTable(elementId, stocks, chartType) {
            const listElement = document.getElementById(elementId);
            if (stocks.length === 0) {
                listElement.innerHTML = `<div class="text-center text-gray-400 py-8">ì•„ì§ ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>"${chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰'}" ì°¨íŠ¸ë¥¼ ì„ íƒí•˜ê³  ì €ì¥í•˜ì„¸ìš”.</div>`;
                return;
            }

            // [ì¶”ê°€] ì˜¤ëŠ˜ ë‚ ì§œ êµ¬í•˜ê¸° (YYMMDD í˜•ì‹) - ì‹ ê³ ê°€ ë±ƒì§€ ë¹„êµìš©
            const now = new Date();
            const todayYYMMDD = now.toISOString().slice(2, 10).replace(/-/g, '');

            listElement.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-gradient-to-r ${chartType === 'minute' ? 'from-amber-100 to-yellow-100 border-amber-300' : 'from-blue-100 to-cyan-100 border-blue-300'} border-b-2">
                                <th class="p-2 text-left font-bold whitespace-nowrap">â‹®</th>
                                <th class="p-2 text-left font-bold whitespace-nowrap">ì¢…ëª©ëª…</th>
                                <th class="p-2 text-center font-bold text-pink-600 whitespace-nowrap">40%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">45%</th>' : ''}
                                <th class="p-2 text-center font-bold text-blue-600 whitespace-nowrap">50%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">55%</th>' : ''}
                                <th class="p-2 text-center font-bold text-yellow-600 whitespace-nowrap">60%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">65%</th>' : ''}
                                <th class="p-2 text-center font-bold text-red-600 whitespace-nowrap">70%</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">25%â†‘</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">33%â†‘</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">50%â†‘</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">75%â†‘</th>
                                <th class="p-2 text-center whitespace-nowrap">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map((stock) => {
                                const globalIndex = stockDatabase.findIndex(s => s.name === stock.name && s.timestamp === stock.timestamp);
                                const selected = globalIndex === currentSelectedIndex ? 'bg-purple-100' : '';
                                
                                const diff = stock.high - stock.low;
                                const buyPoints = {
                                    buy40: adjustBuyPrice(stock.high - (diff * 0.382)),
                                    buy45: adjustBuyPrice(stock.high - (diff * 0.45)),
                                    buy50: adjustBuyPrice(stock.high - (diff * 0.5)),
                                    buy55: adjustBuyPrice(stock.high - (diff * 0.55)),
                                    buy60: adjustBuyPrice(stock.high - (diff * 0.6)),
                                    buy65: adjustBuyPrice(stock.high - (diff * 0.65)),
                                    buy70: adjustBuyPrice(stock.high - (diff * 0.7))
                                };
                                
                                let sells = { p25: '-', p33: '-', p50: '-', p75: '-' };
                                if (stock.bounce) {
                                    const bRange = stock.high - stock.bounce;
                                    const sp25 = adjustSellPrice(stock.bounce + (bRange * 0.25)).adjusted;
                                    const sp33 = adjustSellPrice(stock.bounce + (bRange * 0.33)).adjusted;
                                    const sp50 = adjustSellPrice(stock.bounce + (bRange * 0.50)).adjusted;
                                    const sp75 = adjustSellPrice(stock.bounce + (bRange * 0.75)).adjusted;
                                    
                                    const prox25 = checkSellProximity(stock.currentPrice, sp25, chartType);
                                    const prox33 = checkSellProximity(stock.currentPrice, sp33, chartType);
                                    const prox50 = checkSellProximity(stock.currentPrice, sp50, chartType);
                                    const prox75 = checkSellProximity(stock.currentPrice, sp75, chartType);
                                    
                                    const h = stock.reachedHistory || {};
                                    sells.p25 = (prox25.isReached || h.reachedSell25) ? `<div class="sell-proximity-box-reached">${formatPrice(sp25)}</div>` : (prox25.isClose ? `<div class="sell-proximity-box">${formatPrice(sp25)}</div>` : formatPrice(sp25));
                                    sells.p33 = (prox33.isReached || h.reachedSell33) ? `<div class="sell-proximity-box-reached">${formatPrice(sp33)}</div>` : (prox33.isClose ? `<div class="sell-proximity-box">${formatPrice(sp33)}</div>` : formatPrice(sp33));
                                    sells.p50 = (prox50.isReached || h.reachedSell50) ? `<div class="sell-proximity-box-reached">${formatPrice(sp50)}</div>` : (prox50.isClose ? `<div class="sell-proximity-box">${formatPrice(sp50)}</div>` : formatPrice(sp50));
                                    sells.p75 = (prox75.isReached || h.reachedSell75) ? `<div class="sell-proximity-box-reached">${formatPrice(sp75)}</div>` : (prox75.isClose ? `<div class="sell-proximity-box">${formatPrice(sp75)}</div>` : formatPrice(sp75));
                                }
                                
                                const dday = calculateDDay(stock.highDate);
                                let ddayBadge = '', is40Disabled = false;
                                if (dday.text) {
                                    let cls = 'd-day-badge';
                                    if (chartType === 'minute' && dday.days > 0) {
                                        if (dday.days >= 30) cls += ' danger';
                                        else if (dday.days >= 14) cls += ' warning';
                                        else if (dday.days >= 2) is40Disabled = true;
                                        else if (dday.days >= 0) cls += ' orange';
                                    } else if (chartType === 'daily' && dday.days >= 60) cls += (dday.days >= 80 ? ' danger' : ' warning');
                                    ddayBadge = `<span class="${cls}">${dday.text}</span>`;
                                }
                                
                                const riseRate = (((buyPoints.buy40.adjusted - buyPoints.buy50.adjusted) / buyPoints.buy50.adjusted) * 100).toFixed(2);
                                let rrCls = '';
                                if (chartType === 'minute') rrCls = parseFloat(riseRate) >= 15 ? 'red' : (parseFloat(riseRate) >= 10 ? 'orange' : (parseFloat(riseRate) >= 6 ? 'green' : ''));
                                else rrCls = parseFloat(riseRate) >= 20 ? 'red' : (parseFloat(riseRate) >= 15 ? 'orange' : (parseFloat(riseRate) >= 10 ? 'green' : ''));
                                const rrBadge = `<span class="rise-rate-badge ${rrCls}">${riseRate}%</span>`;
                                
                                let priceInfo = '';
                                if (stock.currentPrice) {
                                    const pc = stock.changeRate > 0 ? 'price-up' : (stock.changeRate < 0 ? 'price-down' : 'price-flat');
                                    const arr = stock.changeRate > 0 ? 'â–²' : (stock.changeRate < 0 ? 'â–¼' : '');
                                    priceInfo = `<span class="realtime-price">
                                        <span id="price-${stock.code}" class="realtime-price-value ${pc}">${stock.currentPrice.toLocaleString()}ì›</span>
                                        <span id="rate-${stock.code}" class="realtime-price-change ${pc}">${arr} ${stock.changeRate.toFixed(2)}%</span>
                                    </span>`;
                                }

                                const h = stock.reachedHistory || {};
                                const prox = {
                                    p40: checkProximity(stock.currentPrice, buyPoints.buy40.adjusted, chartType),
                                    p45: checkProximity(stock.currentPrice, buyPoints.buy45.adjusted, chartType),
                                    p50: checkProximity(stock.currentPrice, buyPoints.buy50.adjusted, chartType),
                                    p55: checkProximity(stock.currentPrice, buyPoints.buy55.adjusted, chartType),
                                    p60: checkProximity(stock.currentPrice, buyPoints.buy60.adjusted, chartType),
                                    p65: checkProximity(stock.currentPrice, buyPoints.buy65.adjusted, chartType),
                                    p70: checkProximity(stock.currentPrice, buyPoints.buy70.adjusted, chartType)
                                };

                                let buys = {};
                                buys.b40 = is40Disabled ? `<span style="text-decoration: line-through; opacity: 0.4;">${formatPrice(buyPoints.buy40.adjusted)}</span> <span style="color: #ef4444;">ğŸš«</span>` : 
                                    (prox.p40.isBelow || h.reached40 ? `<div class="proximity-box-below">${formatPrice(buyPoints.buy40.adjusted)}</div>` : (prox.p40.isEqual ? `<div class="proximity-box-equal">${formatPrice(buyPoints.buy40.adjusted)}</div>` : (prox.p40.isClose ? `<div class="proximity-box">${formatPrice(buyPoints.buy40.adjusted)}</div>` : formatPrice(buyPoints.buy40.adjusted))));
                                buys.b45 = h.reached45 ? `<div class="proximity-box-below">${formatPrice(buyPoints.buy45.adjusted)}</div>` : formatPrice(buyPoints.buy45.adjusted);
                                buys.b50 = (prox.p50.isBelow || h.reached50 ? `<div class="proximity-box-below">${formatPrice(buyPoints.buy50.adjusted)}</div>` : (prox.p50.isEqual ? `<div class="proximity-box-equal">${formatPrice(buyPoints.buy50.adjusted)}</div>` : (prox.p50.isClose ? `<div class="proximity-box">${formatPrice(buyPoints.buy50.adjusted)}</div>` : formatPrice(buyPoints.buy50.adjusted))));
                                buys.b55 = h.reached55 ? `<div class="proximity-box-below">${formatPrice(buyPoints.buy55.adjusted)}</div>` : formatPrice(buyPoints.buy55.adjusted);
                                buys.b60 = (prox.p60.isBelow || h.reached60 ? `<div class="proximity-box-below">${formatPrice(buyPoints.buy60.adjusted)}</div>` : (prox.p60.isEqual ? `<div class="proximity-box-equal">${formatPrice(buyPoints.buy60.adjusted)}</div>` : (prox.p60.isClose ? `<div class="proximity-box">${formatPrice(buyPoints.buy60.adjusted)}</div>` : formatPrice(buyPoints.buy60.adjusted))));
                                buys.b65 = h.reached65 ? `<div class="proximity-box-below">${formatPrice(buyPoints.buy65.adjusted)}</div>` : formatPrice(buyPoints.buy65.adjusted);
                                buys.b70 = (prox.p70.isBelow || h.reached70 ? `<div class="proximity-box-below">${formatPrice(buyPoints.buy70.adjusted)}</div>` : (prox.p70.isEqual ? `<div class="proximity-box-equal">${formatPrice(buyPoints.buy70.adjusted)}</div>` : (prox.p70.isClose ? `<div class="proximity-box">${formatPrice(buyPoints.buy70.adjusted)}</div>` : formatPrice(buyPoints.buy70.adjusted))));

                                // [ì¶”ê°€] ì‹ ê³ ê°€ ê°±ì‹  ë±ƒì§€ ë¡œì§
                                // highDateê°€ ì¡´ì¬í•˜ê³ , ì˜¤ëŠ˜ ë‚ ì§œ(YYMMDD)ì™€ ê°™ìœ¼ë©´ true
                                const isNewHighToday = stock.highDate && String(stock.highDate) === todayYYMMDD;
                                const newHighBadge = isNewHighToday ? `<span class="new-high-badge" title="ì˜¤ëŠ˜ ì‹ ê³ ê°€ ê°±ì‹ ë¨">N</span>` : '';

                                return `
                                    <tr class="${selected} ${chartType === 'minute' ? 'hover:bg-amber-50' : 'hover:bg-blue-50'} cursor-pointer border-b transition-colors whitespace-nowrap" draggable="true" ondragstart="handleDragStart(event, ${globalIndex})" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${globalIndex})" ondragend="handleDragEnd(event)" onclick="loadStock(${globalIndex})">
                                        <td class="drag-handle" onclick="event.stopPropagation()">â‹®â‹®</td>
                                        <td class="p-2 font-bold">${stock.name}${newHighBadge}${ddayBadge}${rrBadge}${priceInfo}</td>
                                        <td class="p-2 text-center text-pink-600 font-semibold">${buys.b40}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${buys.b45}</td>` : ''}
                                        <td class="p-2 text-center text-blue-600 font-semibold">${buys.b50}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${buys.b55}</td>` : ''}
                                        <td class="p-2 text-center text-yellow-600 font-semibold">${buys.b60}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${buys.b65}</td>` : ''}
                                        <td class="p-2 text-center text-red-600 font-semibold">${buys.b70}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sells.p25}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sells.p33}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sells.p50}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sells.p75}</td>
                                        <td class="p-2 text-center"><button class="delete-btn" onclick="deleteStock(${globalIndex}, event)">ì‚­ì œ</button></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function handleDragStart(e, index) { draggedIndex = index; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDrop(e, targetIndex) {
            e.preventDefault(); e.stopPropagation();
            if (draggedIndex === null || draggedIndex === targetIndex) return false;
            const draggedItem = stockDatabase[draggedIndex];
            stockDatabase.splice(draggedIndex, 1);
            stockDatabase.splice(targetIndex, 0, draggedItem);
            if (currentSelectedIndex === draggedIndex) currentSelectedIndex = targetIndex;
            else if (draggedIndex < currentSelectedIndex && targetIndex >= currentSelectedIndex) currentSelectedIndex--;
            else if (draggedIndex > currentSelectedIndex && targetIndex <= currentSelectedIndex) currentSelectedIndex++;
            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
            renderStockList();
            return false;
        }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); draggedIndex = null; }

        function loadStock(index) {
            if (draggedIndex !== null) return;
            currentSelectedIndex = index;
            const stock = stockDatabase[index];
            document.getElementById('chartType').value = stock.chartType || 'minute';
            document.getElementById('stockName').value = stock.name || '';
            document.getElementById('stockCode').value = stock.code || '';
            document.getElementById('highDate').value = stock.highDate || '';
            document.getElementById('highPrice').value = stock.high ? stock.high.toLocaleString('ko-KR') : '';
            document.getElementById('lowPrice').value = stock.low ? stock.low.toLocaleString('ko-KR') : '';
            document.getElementById('bouncePrice').value = stock.bounce !== null && stock.bounce !== undefined ? stock.bounce.toLocaleString('ko-KR') : '';
            calculate();
            renderStockList();
            document.getElementById('stockName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function deleteStock(index, event) {
            event.stopPropagation();
            const stock = stockDatabase[index];
            if (confirm(`"${stock.name}" ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                stockDatabase.splice(index, 1);
                localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                if (currentSelectedIndex === index) currentSelectedIndex = -1;
                else if (currentSelectedIndex > index) currentSelectedIndex--;
                renderStockList();
                registerAllStocks();
            }
        }

        window.onload = function() {
            renderStockList();
            gapiLoaded();
            gisLoaded();
            connectKiwoomAPI();
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) { clearInterval(waitForInit); await restoreLoginState(); }
            }, 100);
        };
    </script>
    
    <div id="alertModal" class="alert-modal">
        <div class="alert-modal-content">
            <h2 class="text-2xl font-bold mb-6">ğŸ”” ì•Œë¦¼ ì„¤ì •</h2>
            <div class="space-y-4">
                <div class="flex items-center justify-between"><label class="font-semibold">ì•Œë¦¼ìŒ í™œì„±í™”</label><label class="toggle-switch"><input type="checkbox" id="soundAlertToggle" checked><span class="toggle-slider"></span></label></div>
                <div><label class="font-semibold block mb-2">ì•Œë¦¼ ë¯¼ê°ë„ (ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘ %)</label><input type="number" id="alertThreshold" value="2" min="0.5" max="10" step="0.5" class="border-2 border-gray-300 rounded-lg px-4 py-2 w-full"><p class="text-sm text-gray-600 mt-1">ë§¤ìˆ˜íƒ€ì ì—ì„œ Â±ì´ ë²”ìœ„ ë‚´ì— ì˜¤ë©´ ì•Œë¦¼</p></div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4"><h3 class="font-semibold text-blue-900 mb-2">ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì„¤ì •</h3><p class="text-sm text-blue-800 mb-2">í…”ë ˆê·¸ë¨ ì•Œë¦¼ì€ ì„œë²„(app.py) íŒŒì¼ì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤:</p><ol class="text-sm text-blue-700 list-decimal ml-5 space-y-1"><li>BotFatherì—ì„œ ë´‡ ìƒì„± í›„ í† í° ë°›ê¸°</li><li>app.pyì—ì„œ TELEGRAM_BOT_TOKEN ì„¤ì •</li><li>ë´‡ê³¼ ëŒ€í™” í›„ TELEGRAM_CHAT_ID ì„¤ì •</li><li>TELEGRAM_ENABLED = Trueë¡œ ë³€ê²½</li></ol></div>
                <div class="flex gap-3"><button onclick="testAlertSound()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition">ğŸ”Š ë§¤ìˆ˜ ì•Œë¦¼ìŒ</button><button onclick="testSellAlertSound()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">ğŸ”Š ë§¤ë„ ì•Œë¦¼ìŒ</button></div>
            </div>
            <div class="flex gap-3 mt-6"><button onclick="saveAlertSettings()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">ì €ì¥</button><button onclick="closeAlertSettings()" class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">ë‹«ê¸°</button></div>
        </div>
    </div>
    
    <script>
        let soundAlertEnabled = true;
        let alertThreshold = 2.0;
        let audioContext;
        let alertSound;
        
        function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        function playAlertSound() {
            if (!soundAlertEnabled) return;
            try {
                initAudio();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800; gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.2);
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator(); const gain2 = audioContext.createGain();
                    osc2.connect(gain2); gain2.connect(audioContext.destination);
                    osc2.frequency.value = 1000; gain2.gain.setValueAtTime(0.3, audioContext.currentTime); gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    osc2.start(audioContext.currentTime); osc2.stop(audioContext.currentTime + 0.2);
                }, 150);
            } catch (e) { console.error('ì•Œë¦¼ìŒ ì¬ìƒ ì˜¤ë¥˜:', e); }
        }
        
        let sellAlertAudio = null;
        function initSellAlertSound() { if (!sellAlertAudio) { sellAlertAudio = new Audio('sell_alert.mp3'); sellAlertAudio.volume = 0.7; } }
        function playSellAlertSound() {
            if (!soundAlertEnabled) return;
            try { initSellAlertSound(); sellAlertAudio.currentTime = 0; sellAlertAudio.play().catch(e => { playFallbackSellSound(); }); } catch (e) { playFallbackSellSound(); }
        }
        function playFallbackSellSound() {
            try {
                initAudio();
                const o = audioContext.createOscillator(); const g = audioContext.createGain(); o.connect(g); g.connect(audioContext.destination);
                o.frequency.value = 1200; g.gain.setValueAtTime(0.3, audioContext.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                o.start(audioContext.currentTime); o.stop(audioContext.currentTime + 0.15);
                setTimeout(() => { const o2=audioContext.createOscillator();const g2=audioContext.createGain();o2.connect(g2);g2.connect(audioContext.destination);o2.frequency.value=1500;g2.gain.setValueAtTime(0.3,audioContext.currentTime);g2.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.15);o2.start(audioContext.currentTime);o2.stop(audioContext.currentTime+0.15); }, 100);
                setTimeout(() => { const o3=audioContext.createOscillator();const g3=audioContext.createGain();o3.connect(g3);g3.connect(audioContext.destination);o3.frequency.value=1800;g3.gain.setValueAtTime(0.3,audioContext.currentTime);g3.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.2);o3.start(audioContext.currentTime);o3.stop(audioContext.currentTime+0.2); }, 200);
            } catch (e) {}
        }
        
        function testAlertSound() { playAlertSound(); }
        function testSellAlertSound() { playSellAlertSound(); }
        
        function showAlertToast(message, type = 'near', watchMode = 'buy') {
            const existingToast = document.querySelector('.alert-toast');
            if (existingToast) existingToast.remove();
            const toast = document.createElement('div');
            toast.className = 'alert-toast';
            let title, bgColor;
            if (watchMode === 'sell') { title = type === 'reached' ? 'ğŸ’° ë§¤ë„íƒ€ì  ë„ë‹¬!' : 'ğŸ“ˆ ë§¤ë„íƒ€ì  ê·¼ì ‘!'; bgColor = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)'; }
            else { title = type === 'reached' ? 'ğŸ¯ ë§¤ìˆ˜íƒ€ì  ë„ë‹¬!' : 'âš ï¸ ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘!'; bgColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'; }
            toast.style.background = bgColor;
            toast.innerHTML = `<div class="font-bold mb-1">${title}</div><div class="text-sm">${message}</div>`;
            document.body.appendChild(toast);
            if (watchMode === 'sell') playSellAlertSound(); else playAlertSound();
            setTimeout(() => { toast.style.animation = 'slideIn 0.3s ease-out reverse'; setTimeout(() => toast.remove(), 300); }, 5000);
        }
        
        function openAlertSettings() {
            document.getElementById('alertModal').classList.add('active');
            soundAlertEnabled = localStorage.getItem('soundAlertEnabled') !== 'false';
            alertThreshold = parseFloat(localStorage.getItem('alertThreshold') || '2.0');
            document.getElementById('soundAlertToggle').checked = soundAlertEnabled;
            document.getElementById('alertThreshold').value = alertThreshold;
        }
        function closeAlertSettings() { document.getElementById('alertModal').classList.remove('active'); }
        function saveAlertSettings() {
            soundAlertEnabled = document.getElementById('soundAlertToggle').checked;
            alertThreshold = parseFloat(document.getElementById('alertThreshold').value);
            localStorage.setItem('soundAlertEnabled', soundAlertEnabled);
            localStorage.setItem('alertThreshold', alertThreshold);
            if (socket && socket.connected) socket.emit('update_alert_config', { threshold: alertThreshold });
            alert('ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeAlertSettings();
        }
        
        soundAlertEnabled = localStorage.getItem('soundAlertEnabled') !== 'false';
        alertThreshold = parseFloat(localStorage.getItem('alertThreshold') || '2.0');
    </script>
</body>
</html>